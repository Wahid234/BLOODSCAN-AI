{# CBC_App/templates/doctor_inbox.html #}
{% extends "base.html" %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .card-compact { padding: .75rem; }
  .profile-thumb { width:56px; height:56px; object-fit:cover; border-radius:50%; }
  .small-muted { font-size:.9rem; color:#6c757d; }
  .status-badge { min-width:86px; display:inline-block; text-align:center; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Shared reports — Inbox</h3>
      <div class="small-muted">Reports shared with you by patients</div>
    </div>
    <div>
      <a href="{% url 'CBC_App:doctor_inbox' %}" class="btn btn-outline-secondary btn-sm">Refresh</a>
    </div>
  </div>

  {% if shared_reports %}
    <div class="row g-3">
      {% for s in shared_reports %}
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body d-flex gap-3 align-items-start">
            <div class="d-flex flex-column align-items-center">
              {% if s.sender.userprofile.profile_image %}
                <img src="{{ s.sender.userprofile.profile_image.url }}" class="profile-thumb" alt="sender">
              {% else %}
                <div class="profile-thumb d-flex align-items-center justify-content-center bg-secondary text-white">
                  {{ s.sender.user.username|slice:":1"|upper }}
                </div>
              {% endif %}
            </div>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="mb-0">{{ s.sender.user.username }}</h6>
                  <div class="small-muted">Shared on {{ s.created_at|date:"Y-m-d H:i" }} · {{ s.tests.count }} test(s)</div>
                  {% if s.message %}
                    <div class="mt-2"><strong>Message:</strong> {{ s.message|linebreaksbr }}</div>
                  {% endif %}
                </div>

                <div class="text-end">
                  {% if s.status == 'pending' %}
                    <span class="badge bg-warning text-dark status-badge">Pending</span>
                  {% elif s.status == 'viewed' %}
                    <span class="badge bg-info text-dark status-badge">Viewed</span>
                  {% elif s.status == 'responded' %}
                    <span class="badge bg-success status-badge">Responded</span>
                  {% else %}
                    <span class="badge bg-secondary status-badge">{{ s.status }}</span>
                  {% endif %}

                  <div class="mt-2">
                    <a href="{% url 'CBC_App:shared_detail' s.id %}" class="btn btn-sm btn-outline-primary">Open</a>

                    {# Accept/Reject buttons (AJAX) #}
                    <button class="btn btn-sm btn-success ms-1 btn-accept" data-id="{{ s.id }}">Accept</button>
                    <button class="btn btn-sm btn-danger ms-1 btn-reject" data-id="{{ s.id }}">Reject</button>
                  </div>
                </div>
              </div>

              {# Quick preview of tests (first 3) #}
              <div class="mt-3">
                <div class="row g-2">
                  {% for t in s.tests.all|slice:":3" %}
                    <div class="col-auto">
                      <div class="border rounded px-2 py-1 small">
                        <strong>{{ t.test.display_name|default:t.label_raw }}</strong>
                        <div class="small-muted">{{ t.value_raw }} {{ t.unit }}</div>
                      </div>
                    </div>
                  {% empty %}
                    <div class="small-muted">No individual tests (document only).</div>
                  {% endfor %}
                </div>
              </div>

            </div>

          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card text-center p-4">
      <div class="card-body">
        <h5 class="card-title">No shared reports yet</h5>
        <p class="small-muted">Patients will see your name when they choose a doctor to share results with.</p>
      </div>
    </div>
  {% endif %}
</div>

<script>
(function(){
  function getCookie(name) {
    let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  async function postJson(url, data){
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
      body: data instanceof FormData ? data : JSON.stringify(data)
    });
    return resp.json();
  }

  document.querySelectorAll('.btn-accept').forEach(btn=>{
    btn.addEventListener('click', async function(){
      const id = this.dataset.id;
      if (!confirm('Mark this shared report as ACCEPTED/viewed?')) return;
      try {
        const fd = new FormData(); fd.append('shared_id', id);
        const res = await postJson("{% url 'CBC_App:shared_accept' %}", fd);
        if (res.ok) location.reload(); else alert('Action failed: ' + (res.error||JSON.stringify(res)));
      } catch(e){ alert('Network error'); }
    });
  });

  document.querySelectorAll('.btn-reject').forEach(btn=>{
    btn.addEventListener('click', async function(){
      const id = this.dataset.id;
      if (!confirm('Reject / archive this shared report?')) return;
      try {
        const fd = new FormData(); fd.append('shared_id', id);
        const res = await postJson("{% url 'CBC_App:shared_reject' %}", fd);
        if (res.ok) location.reload(); else alert('Action failed: ' + (res.error||JSON.stringify(res)));
      } catch(e){ alert('Network error'); }
    });
  });

})();
</script>
{% endblock %}
