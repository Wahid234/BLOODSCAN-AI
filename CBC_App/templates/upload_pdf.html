  {% extends "base.html" %}

  {% block head %}
    {# إذا كان base.html لا يحتوي Bootstrap، أبقِ هذا؛ وإلاّ احذفه. #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      /* تصميم مخصص لخانة الرفع */
      .upload-card { max-width: 900px; margin: 0 auto; }
      .dropzone {
        border: 2px dashed #e3e7eb;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
        transition: border-color .15s ease, background-color .15s ease, box-shadow .15s ease;
        cursor: pointer;
        min-height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: .5rem;
      }
      .dropzone.dragover {
        border-color: #0d6efd;
        box-shadow: 0 6px 18px rgba(13,110,253,.08);
        background: #f8fbff;
      }
      .dropzone .muted { color: #6c757d; font-size: .95rem; }
      .file-info { font-weight: 600; color: #333; }
      
      @media (max-width: 576px) {
        .pdf-preview { height: 30%%; }
        .dropzone { padding: 18px; min-height: 140px; }
      }
     .pdf-preview {
  width: 100%;
  height: 80vh;   /* امتداد كبير حسب ارتفاع الشاشة */
  max-height: 900px;  /* حد أقصى حتى لا تتمدد أكثر من اللازم */
  border-radius: 8px;
  border: 1px solid #e9ecef;
  overflow: hidden;
}

#pdfPreview {
  width: 100%;
  height: 100%;
}
#previewWrap {
  width: 100%;
  height:500px;
}

    </style>
  {% endblock %}

  {% block content %}
  <div class="container py-5">
    <div class="upload-card">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-sm-flex align-items-start justify-content-between gap-3">
            <div>
              <h4 class="card-title mb-1">Upload PDF report</h4>
              <p class="small-muted mb-0">Upload your laboratory PDF report. The system will extract tests and interpret them automatically.</p>
            </div>
            <div class="text-sm-end mt-2 mt-sm-0">
              <a href="{% url 'CBC_App:manual_entry' %}" class="btn btn-outline-secondary btn-sm">Manual entry</a>
            </div>
          </div>

          <hr/>

          {# Show form non-field errors #}
          {% if form.non_field_errors %}
            <div class="alert alert-danger">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="uploadForm" class="mb-3">
            {% csrf_token %}

            <div id="dropzone" class="dropzone mb-3" role="button" tabindex="0">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#0d6efd" class="bi bi-file-earmark-arrow-up mb-2" viewBox="0 0 16 16">
                <path d="M8 5a.5.5 0 0 1 .5.5V8h1.5a.5.5 0 0 1 0 1H8.5v2.5a.5.5 0 0 1-1 0V9H6a.5.5 0 0 1 0-1h1.5V5.5A.5.5 0 0 1 8 5z"/>
                <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h6.5L14 4.5zM10 1v3a1 1 0 0 0 1 1h3" />
              </svg>
              <div class="file-info" id="dzLabel">Drag & drop PDF here or click to browse</div>
              <div class="muted">Supported: PDF. Max size: 10MB.</div>

              {# Real file input (kept visually hidden) #}
              <input id="fileInput" type="file" name="file" accept="application/pdf" style="display:none;" required>
            </div>

            <div class="row gx-2 align-items-center">
              <div class="col-md-8">
                <div id="selectedFile" class="small text-muted">No file selected</div>
              </div>
              <div class="col-md-4 text-md-end mt-2 mt-md-0">
                <button id="submitBtn" class="btn btn-primary" type="submit" disabled>Upload & Parse</button>
              </div>
            </div>
          </form>

          {# Error box placeholder (server-side errors) #}
          <div id="serverErrorBox" class="mt-3" style="display:none;"></div>

          {# PDF preview (hidden until a file is chosen and browser supports embedding) #}
          <div id="previewWrap" class="mt-4" style="display:none;">
            <h6 class="mb-2">Preview</h6>
            <div class="pdf-preview">
              <object id="pdfPreview" data="" type="application/pdf" width="100%" height="100%">
                <div class="p-3 small text-muted">Preview not available. The file will be processed after upload.</div>
              </object>
            </div>
          </div>

          <div class="mt-4 small text-muted">
            <strong>Tip:</strong> If automatic extraction fails, use <a href="{% url 'CBC_App:manual_entry' %}">Manual entry</a> to input tests quickly.
          </div>
        </div>
      </div>

      <div class="text-center mt-3">
        <small class="text-muted">Processed securely. Files are only used for parsing and interpretation.</small>
      </div>
    </div>
  </div>

  {# client-side JS to improve UX #}
  <script>
    (function(){
      const drop = document.getElementById('dropzone');
      const input = document.getElementById('fileInput');
      const dzLabel = document.getElementById('dzLabel');
      const selectedFile = document.getElementById('selectedFile');
      const submitBtn = document.getElementById('submitBtn');
      const previewWrap = document.getElementById('previewWrap');
      const pdfPreview = document.getElementById('pdfPreview');
      const uploadForm = document.getElementById('uploadForm');
      const serverErrorBox = document.getElementById('serverErrorBox');

      function setFile(file) {
        serverErrorBox.style.display = 'none';
        if (!file) {
          selectedFile.textContent = "No file selected";
          submitBtn.disabled = true;
          previewWrap.style.display = 'none';
          pdfPreview.setAttribute('data', '');
          return;
        }
        selectedFile.textContent = file.name + " — " + Math.round(file.size/1024) + " KB";
        submitBtn.disabled = false;
        // show pdf preview if small and browser supports blob object
        try {
          const url = URL.createObjectURL(file);
          pdfPreview.setAttribute('data', url);
          previewWrap.style.display = '';
        } catch (e) {
          previewWrap.style.display = 'none';
        }
      }

      // clicking dropzone opens file dialog
      drop.addEventListener('click', () => input.click());
      drop.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') input.click(); });

      // drag events
      ['dragenter','dragover'].forEach(ev => {
        drop.addEventListener(ev, (e) => {
          e.preventDefault(); e.stopPropagation();
          drop.classList.add('dragover');
        });
      });
      ['dragleave','drop'].forEach(ev => {
        drop.addEventListener(ev, (e) => {
          e.preventDefault(); e.stopPropagation();
          drop.classList.remove('dragover');
        });
      });

      // drop handling
      drop.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        if (dt && dt.files && dt.files.length) {
          const f = dt.files[0];
          if (f.type !== 'application/pdf') {
            alert('Please upload a PDF file.');
            return;
          }
          input.files = dt.files; // set file input
          setFile(f);
        }
      });

      // file input change
      input.addEventListener('change', (e) => {
        const f = input.files && input.files[0] ? input.files[0] : null;
        if (f && f.type !== 'application/pdf') {
          alert('Please select a PDF file.');
          input.value = '';
          setFile(null);
          return;
        }
        setFile(f);
      });

      // progressive visual feedback for submit
      uploadForm.addEventListener('submit', (e) => {
        // simple client validation
        if (!input.files || !input.files[0]) {
          e.preventDefault();
          alert('Please choose a PDF file to upload.');
          return;
        }
        // disable button to prevent double-submit
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';
      });

      // initialize (if form had initial file widget via server-side)
      (function init() {
        // if server provided a pre-selected file input (rare), reflect that
        const f = input.files && input.files[0] ? input.files[0] : null;
        setFile(f);
      })();
    })();
  </script>
  {% endblock %}

{% comment %} {% extends "base.html" %}
{% block content %}
  <h2>Upload PDF report</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-primary" type="submit">Upload and Parse</button>
  </form>
{% endblock %}  {% endcomment %}
